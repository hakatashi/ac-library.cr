<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>src/atcoder.cr</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="src/atcoder.cr" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This documentation is automatically generated by online-judge-tools/verification-helper" />
<meta property="og:description" content="This documentation is automatically generated by online-judge-tools/verification-helper" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="src/atcoder.cr" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"This documentation is automatically generated by online-judge-tools/verification-helper","headline":"src/atcoder.cr","url":"/ac-library.cr/docs/src/atcoder.cr.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/ac-library.cr/docs/assets/css/style.css?v=">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ac-library.cr/docs/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/ac-library.cr/docs/"></a></h1>

        

        <p><small>This documentation is automatically generated by <a href="https://github.com/online-judge-tools/verification-helper">online-judge-tools/verification-helper</a></small></p>

        

        

        
      </header>
      <section>

      <script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" }},
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      processEscapes: true
    },
    "HTML-CSS": { matchFontHeight: false },
    displayAlign: "left",
    displayIndent: "2em"
  });
</script>



<style type="text/css">
@media screen and (min-width: 900px) {
    div.wrapper {
        width: 100%;
    }
    div.wrapper > header {
        width: 280px;
    }
    div.wrapper > section {
        width: calc(100% - 300px);
    }
}
a:hover, a:focus {
    font-weight: normal;
    text-decoration: underline;
}
h1 a:hover {
    font-weight: bold;
}
h1 a:focus {
    font-weight: bold;
}
</style>



<h1>
<img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> src/atcoder.cr
    
</h1>

<ul>
    <li><a href="/blob/master/src/atcoder.cr">View this file on GitHub</a></li>
    <li>Last update: 2023-02-01 11:03:06+09:00</li>
    
    
    
    
</ul>








    <h2>Depends on</h2>
    <ul>
    
        <li><a href="/ac-library.cr/docs/src/convolution.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/convolution.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/dsu.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/dsu.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/fenwick_tree.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/fenwick_tree.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/graph.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/graph.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/lazy_seg_tree.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/lazy_seg_tree.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/math.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/math.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/max_flow.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/max_flow.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/min_cost_flow.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/min_cost_flow.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/mod_int.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/mod_int.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/prime.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/prime.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/priority_queue.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/priority_queue.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/red_black_tree.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> src/red_black_tree.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/scc.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/scc.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/seg_tree.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/seg_tree.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/skew_heap.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> src/skew_heap.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/string.cr"><img class="emoji" title=":x:" alt=":x:" src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png" height="20" width="20"> src/string.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/src/two_sat.cr"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"> src/two_sat.cr
            
        </a></li>
    
    </ul>









<h2>Code</h2>

<script defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jquery-balloon-js@1.1.2/jquery.balloon.min.js" integrity="sha256-ZEYs9VrgAeNuPvs15E39OsyOJaIkXEEt10fzxJ20+2I=" crossorigin="anonymous"></script>
<script defer type="text/javascript" src="/ac-library.cr/docs/assets/js/copy-button.js"></script>
<link rel="stylesheet" href="/ac-library.cr/docs/assets/css/copy-button.css">

<span><a id="unbundled"></a></span>




<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">require</span> <span class="s">"./*"</span></code></pre></figure>





<span><a id="bundled"></a></span>




<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp"># require "./*"
</span>
<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::convolution](https://atcoder.github.io/ac-library/master/document_en/convolution.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># a = [AtCoder::ModInt998244353.new(1_i64)] * 3
</span>  <span class="cp"># AtCoder::Convolution.convolution(a, a) # =&gt; [1, 2, 3, 2, 1]
</span>  <span class="cp"># ```
</span>  <span class="n">module</span> <span class="n">Convolution</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">bit_reverse</span><span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">bit_length</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="n">zero</span>
      <span class="n">bit_length</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">ret</span> <span class="o">|=</span> <span class="p">((</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_length</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="n">ret</span>
    <span class="n">end</span>

    <span class="cp"># In-place execution of FFT operation.
</span>    <span class="cp"># `T` must implement ModInt operations.
</span>    <span class="cp"># Length of `a` must be power of 2.
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">fft</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">g</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span> <span class="n">forall</span> <span class="n">T</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">size</span>
      <span class="n">bit_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="n">trailing_zeros_count</span>

      <span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">bit_reverse</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bit_length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span>
          <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">bit_length</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">bit</span><span class="o">|</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span>

        <span class="cp"># Butterfly operation
</span>        <span class="n">block_size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
          <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span> <span class="o">**</span> <span class="p">(</span><span class="n">size</span> <span class="c1">// block_size // 2)) ** i</span>
          <span class="p">(</span><span class="n">size</span> <span class="c1">// (block_size * 2)).times do |j|</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">block_size</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">a</span><span class="p">[</span><span class="n">index1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
              <span class="n">a</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span>
              <span class="n">a</span><span class="p">[</span><span class="n">index1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">index2</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span>
            <span class="p">}</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
      <span class="n">fft</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">inv</span><span class="p">)</span>
      <span class="n">a</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">//= a.size</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::convolution.convolution.
</span>    <span class="cp"># TODO: Support for int
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">convolution</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="n">forall</span> <span class="n">T</span>
      <span class="k">return</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">T</span> <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span> <span class="n">b</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">modulo</span> <span class="o">=</span> <span class="n">T</span><span class="o">::</span><span class="n">MOD</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">modulo</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="n">result_size</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>

      <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">trailing_zeros_count</span>

      <span class="k">if</span> <span class="n">result_size</span> <span class="o">&gt;</span> <span class="n">c</span>
        <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"With modulo #{modulo}, total array length must be less than or equal to #{c}"</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">fft_size</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span>
      <span class="n">until</span> <span class="n">fft_size</span> <span class="o">&gt;=</span> <span class="n">result_size</span>
        <span class="n">fft_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="n">input_a</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">fft_size</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">size</span> <span class="o">?</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">T</span><span class="p">.</span><span class="n">zero</span> <span class="p">}</span>
      <span class="n">input_b</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">fft_size</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">.</span><span class="n">size</span> <span class="o">?</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">T</span><span class="p">.</span><span class="n">zero</span> <span class="p">}</span>

      <span class="n">primitive_root</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">get_primitive_root</span><span class="p">(</span><span class="n">modulo</span><span class="p">)</span>
      <span class="n">g</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">primitive_root</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="c1">// fft_size)</span>

      <span class="n">fft</span><span class="p">(</span><span class="n">input_a</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
      <span class="n">fft</span><span class="p">(</span><span class="n">input_b</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

      <span class="n">fft_size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">input_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">input_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">end</span>

      <span class="nf">ifft</span><span class="p">(</span><span class="n">input_a</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>

      <span class="n">input_a</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="n">result_size</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::convolution.convolution_ll.
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">convolution_ll</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">),</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Int64</span> <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span> <span class="n">b</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">a1</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt754974721</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt167772161</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">a3</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt469762049</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt754974721</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt167772161</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">b3</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">ModInt469762049</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">c1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
      <span class="n">c2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
      <span class="n">c3</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">a3</span><span class="p">,</span> <span class="n">b3</span><span class="p">)</span>

      <span class="n">m1</span> <span class="o">=</span> <span class="mi">754</span><span class="n">_974_721_i64</span>
      <span class="n">m2</span> <span class="o">=</span> <span class="mi">167</span><span class="n">_772_161_i64</span>
      <span class="n">m3</span> <span class="o">=</span> <span class="mi">469</span><span class="n">_762_049_i64</span>

      <span class="n">c1</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">).</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="o">|</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">inv_mod</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">n2</span><span class="p">.</span><span class="n">val</span> <span class="o">-</span> <span class="n">n1</span><span class="p">.</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">%</span> <span class="n">m2</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">n1</span><span class="p">.</span><span class="n">val</span> <span class="o">+</span> <span class="n">m1</span> <span class="o">*</span> <span class="n">tmp</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">inv_mod</span><span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">n3</span><span class="p">.</span><span class="n">val</span> <span class="o">-</span> <span class="n">answer</span><span class="p">)</span> <span class="o">%</span> <span class="n">m3</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">m3</span>
        <span class="n">answer</span> <span class="o">+</span> <span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">tmp</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::dsu](https://atcoder.github.io/ac-library/master/document_en/dsu.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># dsu = AtCoder::DSU.new(10)
</span>  <span class="cp"># dsu.merge(0, 2)
</span>  <span class="cp"># dsu.merge(4, 2)
</span>  <span class="cp"># dsu.same?(0, 4) # =&gt; true
</span>  <span class="cp"># dsu.size(4)     # =&gt; 3
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">DSU</span>
    <span class="n">getter</span> <span class="n">parents</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>
    <span class="n">getter</span> <span class="n">sizes</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>
    <span class="n">getter</span> <span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">parents</span> <span class="o">=</span> <span class="n">Array</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">to_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">sizes</span> <span class="o">=</span> <span class="n">Array</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::dsu.leader(node).
</span>    <span class="n">def</span> <span class="n">leader</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">until</span> <span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span>
        <span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
      <span class="n">end</span>
      <span class="n">node</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::dsu.merge(a, b).
</span>    <span class="n">def</span> <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">leader_a</span> <span class="o">=</span> <span class="n">leader</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">to_i64</span><span class="p">)</span>
      <span class="n">leader_b</span> <span class="o">=</span> <span class="n">leader</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">to_i64</span><span class="p">)</span>
      <span class="n">unless</span> <span class="n">leader_a</span> <span class="o">==</span> <span class="n">leader_b</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">sizes</span><span class="p">[</span><span class="n">leader_a</span><span class="p">]</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">sizes</span><span class="p">[</span><span class="n">leader_b</span><span class="p">]</span>
          <span class="n">leader_a</span><span class="p">,</span> <span class="n">leader_b</span> <span class="o">=</span> <span class="n">leader_b</span><span class="p">,</span> <span class="n">leader_a</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">parents</span><span class="p">[</span><span class="n">leader_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">leader_a</span>
        <span class="err">@</span><span class="n">sizes</span><span class="p">[</span><span class="n">leader_a</span><span class="p">]</span> <span class="o">+=</span> <span class="err">@</span><span class="n">sizes</span><span class="p">[</span><span class="n">leader_b</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::dsu.same(a, b).
</span>    <span class="n">def</span> <span class="n">same</span><span class="o">?</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">leader</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">leader</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::dsu.size().
</span>    <span class="n">def</span> <span class="n">size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">sizes</span><span class="p">[</span><span class="n">leader</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::dsu.groups().
</span>    <span class="cp"># This method returns `Set` instead of list.
</span>    <span class="n">def</span> <span class="n">groups</span>
      <span class="n">groups</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">)).</span><span class="k">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">leader</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
      <span class="n">end</span>
      <span class="n">groups</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">to_set</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::fenwick_tree](https://atcoder.github.io/ac-library/master/document_en/fenwicktree.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># tree = AtCoder::FenwickTree(Int64).new(10)
</span>  <span class="cp"># tree.add(3, 10)
</span>  <span class="cp"># tree.add(5, 20)
</span>  <span class="cp"># tree[3..5]  # =&gt; 30
</span>  <span class="cp"># tree[3...5] # =&gt; 10
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nf">FenwickTree</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">getter</span> <span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>
    <span class="n">getter</span> <span class="n">bits</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">bits</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="n">T</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">bits</span> <span class="o">:</span> <span class="n">Array</span><span class="p">)</span>
      <span class="err">@</span><span class="n">bits</span> <span class="o">=</span> <span class="err">@</span><span class="n">bits</span><span class="p">.</span><span class="n">dup</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">=</span> <span class="err">@</span><span class="n">bits</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="err">@</span><span class="n">size</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">index</span><span class="o">|</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">index</span><span class="p">)</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">up</span> <span class="o">&gt;</span> <span class="err">@</span><span class="n">size</span>

        <span class="err">@</span><span class="n">bits</span><span class="p">[</span><span class="n">up</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="err">@</span><span class="n">bits</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::fenwick_tree.add(index, value)
</span>    <span class="n">def</span> <span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span> <span class="err">#</span> <span class="n">convert</span> <span class="n">to</span> <span class="mi">1</span><span class="o">-</span><span class="n">indexed</span>
      <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="err">@</span><span class="n">size</span>
        <span class="err">@</span><span class="n">bits</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">index</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Exclusive left sum
</span>    <span class="n">def</span> <span class="n">left_sum</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="n">zero</span>
      <span class="k">while</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="err">@</span><span class="n">bits</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">-=</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">index</span>
      <span class="n">end</span>
      <span class="n">ret</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::fenwick_tree.sum(left, right)
</span>    <span class="n">def</span> <span class="n">sum</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
      <span class="n">left_sum</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="o">-</span> <span class="n">left_sum</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="p">[](</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="n">left</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="n">right</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">exclusive</span><span class="o">?</span> <span class="o">?</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">:</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">sum</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./priority_queue.cr"
# ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements standard priority queue like [std::priority_queue](https://en.cppreference.com/w/cpp/container/priority_queue).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># q = AtCoder::PriorityQueue(Int64).new
</span>  <span class="cp"># q &lt;&lt; 1_i64
</span>  <span class="cp"># q &lt;&lt; 3_i64
</span>  <span class="cp"># q &lt;&lt; 2_i64
</span>  <span class="cp"># q.pop # =&gt; 3
</span>  <span class="cp"># q.pop # =&gt; 2
</span>  <span class="cp"># q.pop # =&gt; 1
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nf">PriorityQueue</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">getter</span> <span class="n">heap</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span>
      <span class="n">initialize</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># Initializes queue with the custom comperator.
</span>    <span class="cp">#
</span>    <span class="cp"># If the second argument `b` should be popped earlier than
</span>    <span class="cp"># the first argument `a`, return `true`. Else, return `false`.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># q = AtCoder::PriorityQueue(Int64).new { |a, b| a &gt;= b }
</span>    <span class="cp"># q &lt;&lt; 1_i64
</span>    <span class="cp"># q &lt;&lt; 3_i64
</span>    <span class="cp"># q &lt;&lt; 2_i64
</span>    <span class="cp"># q.pop # =&gt; 1
</span>    <span class="cp"># q.pop # =&gt; 2
</span>    <span class="cp"># q.pop # =&gt; 3
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="o">-&gt;</span> <span class="n">Bool</span><span class="p">)</span>
      <span class="err">@</span><span class="n">heap</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">compare_proc</span> <span class="o">=</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Pushes value into the queue.
</span>    <span class="n">def</span> <span class="n">push</span><span class="p">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="err">@</span><span class="n">heap</span> <span class="o">&lt;&lt;</span> <span class="n">v</span>
      <span class="n">index</span> <span class="o">=</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">while</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">compare_proc</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
          <span class="k">break</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">parent</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">parent</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Alias of `push`
</span>    <span class="n">def</span> <span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Pops value from the queue.
</span>    <span class="n">def</span> <span class="n">pop</span>
      <span class="k">if</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">nil</span>
      <span class="n">end</span>
      <span class="k">if</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">pop</span>
      <span class="n">end</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">first</span>
      <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">pop</span>
      <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span>
        <span class="n">child</span> <span class="o">=</span> <span class="k">if</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="err">@</span><span class="n">compare_proc</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                  <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="k">else</span>
                  <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">end</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">compare_proc</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">child</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
          <span class="k">break</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">child</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="err">@</span><span class="n">heap</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">child</span>
      <span class="n">end</span>
      <span class="n">ret</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the queue is empty.
</span>    <span class="n">delegate</span> <span class="o">:</span><span class="n">empty</span><span class="o">?</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">heap</span>

    <span class="cp"># Returns size of the queue.
</span>    <span class="n">delegate</span> <span class="o">:</span><span class="n">size</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">heap</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="k">class</span> <span class="nc">Graph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span>
    <span class="err">@</span><span class="n">size_bits</span> <span class="o">:</span> <span class="n">Int32</span>
    <span class="n">getter</span> <span class="n">visited</span> <span class="o">:</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">nodes</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">))</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">=</span> <span class="err">@</span><span class="n">nodes</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">EdgeInfo</span>
      <span class="err">@</span><span class="n">adjacencies</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Hash</span><span class="p">(</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="n">Hash</span><span class="p">(</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">).</span><span class="k">new</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">size_bits</span> <span class="o">=</span> <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">size</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">initial_node</span> <span class="o">:</span> <span class="n">NodeInfo</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="n">initial_node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">EdgeInfo</span>
      <span class="err">@</span><span class="n">adjacencies</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Hash</span><span class="p">(</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="n">Hash</span><span class="p">(</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">).</span><span class="k">new</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">size_bits</span> <span class="o">=</span> <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">size</span>
    <span class="n">end</span>

    <span class="cp"># Performs Dijkstra's Algorithm to calculate the distance of each node from `start_node`.
</span>    <span class="cp"># To use this method, `EdgeInfo` must implement `.zero` and `#+(EdgeInfo)` and `#&gt;(EdgeInfo)`.
</span>    <span class="n">def</span> <span class="nf">dijkstra</span><span class="p">(</span><span class="n">start_node</span><span class="p">)</span>
      <span class="n">dist</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
      <span class="n">dist</span><span class="p">[</span><span class="n">start_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">EdgeInfo</span><span class="p">.</span><span class="n">zero</span>

      <span class="n">prev_nodes</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>

      <span class="n">queue</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">PriorityQueue</span><span class="p">({</span><span class="n">EdgeInfo</span><span class="p">,</span> <span class="n">Int64</span><span class="p">}).</span><span class="k">new</span> <span class="p">{</span> <span class="o">|</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">av</span><span class="p">),</span> <span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">bv</span><span class="p">)</span><span class="o">|</span> <span class="n">ad</span> <span class="o">&gt;</span> <span class="n">bd</span> <span class="p">}</span>
      <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">EdgeInfo</span><span class="p">.</span><span class="n">zero</span><span class="p">,</span> <span class="n">start_node</span><span class="p">.</span><span class="n">to_i64</span><span class="p">}</span>

      <span class="n">until</span> <span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
        <span class="n">current_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">not_nil</span><span class="o">!</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">current_dist</span>

        <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">edge_id</span><span class="p">)</span><span class="o">|</span>
          <span class="n">cost</span> <span class="o">=</span> <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span>
          <span class="n">target_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">to</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">target_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">target_dist</span> <span class="o">&gt;</span> <span class="n">current_dist</span> <span class="o">+</span> <span class="n">cost</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_dist</span> <span class="o">+</span> <span class="n">cost</span>
            <span class="n">prev_nodes</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">current_dist</span> <span class="o">+</span> <span class="n">cost</span><span class="p">,</span> <span class="n">to</span><span class="p">}</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">Array</span><span class="p">({</span><span class="n">dist</span><span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">prev</span><span class="o">:</span> <span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">}).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="p">{</span><span class="n">dist</span><span class="o">:</span> <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">prev</span><span class="o">:</span> <span class="n">prev_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">dfs</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">initial_value</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">(</span>
              <span class="n">node</span><span class="o">:</span> <span class="n">Int64</span><span class="p">,</span>
              <span class="n">node_info</span><span class="o">:</span> <span class="n">NodeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
              <span class="n">edge</span><span class="o">:</span> <span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
              <span class="n">edge_info</span><span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
              <span class="n">parent</span><span class="o">:</span> <span class="n">Int64</span><span class="p">,</span>
            <span class="p">),</span> <span class="p">(</span><span class="n">T</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="n">forall</span> <span class="n">T</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nl">node:</span>      <span class="n">node</span><span class="p">,</span>
        <span class="nl">node_info:</span> <span class="err">@</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">].</span><span class="n">as</span><span class="p">(</span><span class="n">NodeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
        <span class="nl">edge:</span>      <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
        <span class="nl">edge_info:</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
        <span class="nl">parent:</span>    <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">,</span>
      <span class="p">}</span>
      <span class="n">block</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">new_value</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">parent</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">value</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">(</span>
                      <span class="n">node</span><span class="o">:</span> <span class="n">Int64</span><span class="p">,</span>
                      <span class="n">node_info</span><span class="o">:</span> <span class="n">NodeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
                      <span class="n">edge</span><span class="o">:</span> <span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
                      <span class="n">edge_info</span><span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span>
                      <span class="n">parent</span><span class="o">:</span> <span class="n">Int64</span><span class="p">,</span>
                    <span class="p">),</span> <span class="p">(</span><span class="n">T</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="n">forall</span> <span class="n">T</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">node</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">node</span><span class="p">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="err">@</span><span class="n">visited</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nl">node:</span>      <span class="n">child</span><span class="p">,</span>
          <span class="nl">node_info:</span> <span class="err">@</span><span class="n">nodes</span><span class="p">[</span><span class="n">child</span><span class="p">].</span><span class="n">as</span><span class="p">(</span><span class="n">NodeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
          <span class="nl">edge:</span>      <span class="n">edge</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
          <span class="nl">edge_info:</span> <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">].</span><span class="n">as</span><span class="p">(</span><span class="n">EdgeInfo</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">),</span>
          <span class="nl">parent:</span>    <span class="n">node</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">block</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">new_value</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">dfs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nf">DirectedGraph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Graph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">add_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">&lt;&lt;</span> <span class="n">edge</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">edges</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">][</span><span class="n">to</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_id</span>
      <span class="n">edge_id</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">get_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">][</span><span class="n">to</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span>
      <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">update_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">][</span><span class="n">to</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span>
      <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span>
      <span class="n">edge_id</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">UndirectedGraph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Graph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">add_edge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">&lt;&lt;</span> <span class="n">edge</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">edges</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_id</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">a</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_id</span>
      <span class="n">edge_id</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">get_edge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span>
      <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">update_edge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">edge_id</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">.</span><span class="n">to_i64</span><span class="p">]</span>
      <span class="err">@</span><span class="n">edges</span><span class="p">[</span><span class="n">edge_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge</span>
      <span class="n">edge_id</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">Tree</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">UndirectedGraph</span><span class="p">(</span><span class="n">NodeInfo</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">)</span>
    <span class="err">@</span><span class="n">lca_root</span> <span class="o">:</span> <span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span>
    <span class="err">@</span><span class="n">lca_ancestors</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">))</span> <span class="o">|</span> <span class="n">Nil</span>
    <span class="err">@</span><span class="n">lca_depths</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span>

    <span class="n">def</span> <span class="n">diameter</span>
      <span class="err">@</span><span class="n">farthest_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span>
      <span class="err">@</span><span class="n">farthest_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="o">:</span><span class="n">edge_info</span><span class="p">]</span>
        <span class="n">depth</span> <span class="o">+=</span> <span class="n">weight</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">weight</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">farthest_depth</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span> <span class="o">&lt;</span> <span class="n">depth</span>
          <span class="err">@</span><span class="n">farthest_node</span> <span class="o">=</span> <span class="n">node</span>
          <span class="err">@</span><span class="n">farthest_depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="n">end</span>
        <span class="n">callback</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">start_node</span> <span class="o">=</span> <span class="err">@</span><span class="n">farthest_node</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
      <span class="err">@</span><span class="n">farthest_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span>
      <span class="err">@</span><span class="n">farthest_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="err">@</span><span class="n">parents</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">dfs</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="o">:</span><span class="n">edge_info</span><span class="p">]</span>
        <span class="n">depth</span> <span class="o">+=</span> <span class="n">weight</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">weight</span>
        <span class="err">@</span><span class="n">parents</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="o">:</span><span class="n">parent</span><span class="p">]</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">farthest_depth</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span> <span class="o">&lt;</span> <span class="n">depth</span>
          <span class="err">@</span><span class="n">farthest_node</span> <span class="o">=</span> <span class="n">node</span>
          <span class="err">@</span><span class="n">farthest_depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="n">end</span>
        <span class="n">callback</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="p">{</span><span class="err">@</span><span class="n">farthest_depth</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="err">@</span><span class="n">farthest_node</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">,</span> <span class="err">@</span><span class="n">parents</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">lca_precompute</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
      <span class="n">lca_ancestors</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size_bits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">lca_depths</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>

      <span class="n">dfs</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">callback</span><span class="o">|</span>
        <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="o">:</span><span class="n">parent</span><span class="p">]</span>
        <span class="n">lca_depths</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="n">callback</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="mf">1.</span><span class="n">upto</span><span class="p">(</span><span class="err">@</span><span class="n">size_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span>
          <span class="k">else</span>
            <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">lca_root</span> <span class="o">=</span> <span class="n">root</span>
      <span class="err">@</span><span class="n">lca_ancestors</span> <span class="o">=</span> <span class="n">lca_ancestors</span>
      <span class="err">@</span><span class="n">lca_depths</span> <span class="o">=</span> <span class="n">lca_depths</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="nf">lca_nth_prev</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
      <span class="n">lca_ancestors</span> <span class="o">=</span> <span class="err">@</span><span class="n">lca_ancestors</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>

      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="n">until</span> <span class="n">dist</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">dist</span><span class="p">.</span><span class="n">odd</span><span class="o">?</span>
          <span class="n">node</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">raise</span> <span class="n">Exception</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"#{dist}th previous node of #{node} does not exist"</span><span class="p">)</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="n">dist</span> <span class="c1">//= 2</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="n">node</span>
    <span class="n">end</span>

    <span class="cp"># ameba:disable Metrics/CyclomaticComplexity
</span>    <span class="n">def</span> <span class="n">lca</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">if</span> <span class="err">@</span><span class="n">lca_root</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">lca_precompute</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">lca_ancestors</span> <span class="o">=</span> <span class="err">@</span><span class="n">lca_ancestors</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
      <span class="n">lca_depths</span> <span class="o">=</span> <span class="err">@</span><span class="n">lca_depths</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>

      <span class="n">depth_a</span> <span class="o">=</span> <span class="n">lca_depths</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
      <span class="n">depth_b</span> <span class="o">=</span> <span class="n">lca_depths</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">depth_a</span> <span class="o">&lt;</span> <span class="n">depth_b</span>
        <span class="n">depth_a</span><span class="p">,</span> <span class="n">depth_b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">depth_b</span><span class="p">,</span> <span class="n">depth_a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">depth_a</span> <span class="o">!=</span> <span class="n">depth_b</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">lca_nth_prev</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">depth_a</span> <span class="o">-</span> <span class="n">depth_b</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
        <span class="k">return</span> <span class="n">a</span>
      <span class="n">end</span>

      <span class="p">(</span><span class="err">@</span><span class="n">size_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">downto</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
          <span class="n">next</span>
        <span class="n">end</span>

        <span class="k">if</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
          <span class="n">a</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
          <span class="n">b</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">a</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">lca_ancestors</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">raise</span> <span class="n">Exception</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"Assertion error"</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">a</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">lca_node</span> <span class="o">=</span> <span class="n">lca</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

      <span class="n">lca_depths</span> <span class="o">=</span> <span class="err">@</span><span class="n">lca_depths</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
      <span class="p">(</span><span class="n">lca_depths</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">lca_depths</span><span class="p">[</span><span class="n">lca_node</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">lca_depths</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">-</span> <span class="n">lca_depths</span><span class="p">[</span><span class="n">lca_node</span><span class="p">])</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if node `c` is on the path from `a` to `b`.
</span>    <span class="n">def</span> <span class="n">on_path</span><span class="o">?</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
      <span class="n">dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">dist</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::lazy_segtree](https://atcoder.github.io/ac-library/master/document_en/lazysegtree.html).
</span>  <span class="cp">#
</span>  <span class="cp"># The identity element will be implicitly defined as nil, so you don't
</span>  <span class="cp"># have to manually define it. In the other words, you cannot include
</span>  <span class="cp"># nil into an element of the monoid.
</span>  <span class="cp">#
</span>  <span class="cp"># Similarly, the identity map of F will be implicitly defined as nil,
</span>  <span class="cp"># so you don't have to manually define it. In the other words, you
</span>  <span class="cp"># cannot include nil into an element of the set F.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># op = -&gt;(a : Int32, b : Int32) { [a, b].min }
</span>  <span class="cp"># mapping = -&gt;(f : Int32, x : Int32) { f }
</span>  <span class="cp"># composition = -&gt;(a : Int32, b : Int32) { a }
</span>  <span class="cp"># tree = AtCoder::LazySegTree(Int32, Int32).new((0...100).to_a, op, mapping, composition)
</span>  <span class="cp"># tree[10...50] # =&gt; 10
</span>  <span class="cp"># tree[20...60] = 0
</span>  <span class="cp"># tree[50...80] # =&gt; 0
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nf">LazySegTree</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
    <span class="n">getter</span> <span class="n">values</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">values</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="err">@</span><span class="k">operator</span> <span class="o">:</span> <span class="n">S</span><span class="p">,</span> <span class="n">S</span> <span class="o">-&gt;</span> <span class="n">S</span><span class="p">,</span> <span class="err">@</span><span class="n">application</span> <span class="o">:</span> <span class="n">F</span><span class="p">,</span> <span class="n">S</span> <span class="o">-&gt;</span> <span class="n">S</span><span class="p">,</span> <span class="err">@</span><span class="n">composition</span> <span class="o">:</span> <span class="n">F</span><span class="p">,</span> <span class="n">F</span> <span class="o">-&gt;</span> <span class="n">F</span><span class="p">)</span>
      <span class="err">@</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">segment_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">log2</span><span class="p">(</span><span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">).</span><span class="n">ceil</span><span class="p">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="err">@</span><span class="n">segments</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">segment_size</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">applicators</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">F</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">segment_size</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>

      <span class="cp"># initialize segments
</span>      <span class="p">(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">downto</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">child1</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="n">child2</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
          <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">set</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::lazy_segtree.apply(index, applicator).
</span>    <span class="n">def</span> <span class="p">[]</span><span class="o">=</span><span class="p">(</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">applicator</span> <span class="o">:</span> <span class="n">F</span><span class="p">)</span>
      <span class="n">apply_range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">applicator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">..(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">applicator</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::lazy_segtree.apply(left, right, applicator).
</span>    <span class="n">def</span> <span class="p">[]</span><span class="o">=</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">),</span> <span class="n">applicator</span> <span class="o">:</span> <span class="n">F</span><span class="p">)</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">exclusive</span><span class="o">?</span> <span class="o">?</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">:</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">apply_range</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">applicator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">..(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">applicator</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::lazy_segtree.get(index).
</span>    <span class="n">def</span> <span class="p">[](</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">get_range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">..(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)).</span><span class="n">not_nil</span><span class="o">!</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::lazy_segtree.prod(left, right).
</span>    <span class="n">def</span> <span class="p">[](</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">exclusive</span><span class="o">?</span> <span class="o">?</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">:</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">get_range</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">..(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)).</span><span class="n">not_nil</span><span class="o">!</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">operate</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">b</span>
      <span class="n">elsif</span> <span class="n">b</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">a</span>
      <span class="k">else</span>
        <span class="err">@</span><span class="k">operator</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">apply</span><span class="p">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">F</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">x</span> <span class="o">:</span> <span class="n">S</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">x</span>
      <span class="n">elsif</span> <span class="n">x</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">nil</span>
      <span class="k">else</span>
        <span class="err">@</span><span class="n">application</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">compose</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">F</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">F</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">b</span>
      <span class="n">elsif</span> <span class="n">b</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">a</span>
      <span class="k">else</span>
        <span class="err">@</span><span class="n">composition</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Evaluates segment, whose range is `range`. `range` is exclusive here.
</span>    <span class="cp">#
</span>    <span class="cp"># Preconditions:
</span>    <span class="cp"># * segment_index &lt; @segments.size
</span>    <span class="cp"># * range.end - range.begin &gt; 1
</span>    <span class="n">def</span> <span class="n">eval_segment</span><span class="p">(</span><span class="n">segment_index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="n">applicator</span> <span class="o">=</span> <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">applicator</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

      <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">applicator</span><span class="p">,</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">&gt;</span> <span class="mi">2</span>
        <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">applicator</span><span class="p">,</span> <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">applicator</span><span class="p">,</span> <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
      <span class="k">else</span>
        <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">applicator</span><span class="p">,</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">])</span>
        <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">applicator</span><span class="p">,</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">])</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">nil</span>
    <span class="n">end</span>

    <span class="cp"># Applies applicator `f` onto segment, whose range is `range`. `range` is exclusive here.
</span>    <span class="n">def</span> <span class="n">apply_range</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">f</span> <span class="o">:</span> <span class="n">F</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&gt;=</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="n">nil</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
        <span class="n">eval_segment</span><span class="p">(</span><span class="n">segment_index</span><span class="p">,</span> <span class="n">range</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">a</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
        <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="err">@</span><span class="n">applicators</span><span class="p">[</span><span class="n">segment_index</span><span class="p">],</span> <span class="n">f</span><span class="p">)</span>
          <span class="n">eval_segment</span><span class="p">(</span><span class="n">segment_index</span><span class="p">,</span> <span class="n">range</span><span class="p">)</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">])</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">range_median</span> <span class="o">=</span> <span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">+</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="c1">// 2</span>
      <span class="n">child1</span> <span class="o">=</span> <span class="n">apply_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">...</span><span class="n">range_median</span><span class="p">)</span>
      <span class="n">child2</span> <span class="o">=</span> <span class="n">apply_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">range_median</span><span class="p">...</span><span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>

      <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
      <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="cp"># Gets evaluated value of a segment, whose range is `range`. `range` is exclusive here.
</span>    <span class="n">def</span> <span class="n">get_range</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">a</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
        <span class="k">return</span> <span class="n">nil</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
        <span class="n">eval_segment</span><span class="p">(</span><span class="n">segment_index</span><span class="p">,</span> <span class="n">range</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">range_median</span> <span class="o">=</span> <span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">+</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="c1">// 2</span>
      <span class="n">child1</span> <span class="o">=</span> <span class="n">get_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">...</span><span class="n">range_median</span><span class="p">)</span>
      <span class="n">child2</span> <span class="o">=</span> <span class="n">get_range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">range_median</span><span class="p">...</span><span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>

      <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::lazy_segtree.all_prod().
</span>    <span class="n">def</span> <span class="n">all_prod</span>
      <span class="n">self</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">max_right</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">max_left</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./prime.cr"
# ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./math.cr"
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [Ruby's Prime library](https://ruby-doc.com/stdlib/libdoc/prime/rdoc/Prime.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># AtCoder::Prime.first(7) # =&gt; [2, 3, 5, 7, 11, 13, 17]
</span>  <span class="cp"># ```
</span>  <span class="n">module</span> <span class="n">Prime</span>
    <span class="n">extend</span> <span class="n">self</span>
    <span class="n">include</span> <span class="nf">Enumerable</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>

    <span class="err">@@</span><span class="n">primes</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">2</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">3</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">5</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">7</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">11</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">13</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">17</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">19</span><span class="n">_i64</span><span class="p">,</span>
      <span class="mi">23</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">29</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">31</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">37</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">41</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">43</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">47</span><span class="n">_i64</span><span class="p">,</span>
      <span class="mi">53</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">59</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">61</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">67</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">71</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">73</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">79</span><span class="n">_i64</span><span class="p">,</span>
      <span class="mi">83</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">89</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">97</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">101</span><span class="n">_i64</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">def</span> <span class="n">each</span>
      <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">yield</span> <span class="n">get_nth_prime</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">prime_division</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">raise</span> <span class="n">DivisionByZeroError</span><span class="p">.</span><span class="k">new</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>

      <span class="kt">int</span> <span class="o">=</span> <span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">abs</span>
        <span class="n">factors</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="kt">int</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="kt">int</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span>
      <span class="n">end</span>

      <span class="n">until</span> <span class="n">prime</span><span class="o">?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">until</span> <span class="n">prime</span><span class="o">?</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
          <span class="n">factor</span> <span class="o">=</span> <span class="n">find_factor</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">value</span> <span class="o">%</span> <span class="n">factor</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="n">value</span> <span class="c1">//= factor</span>
          <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end</span>
        <span class="n">factors</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="kt">int</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="kt">int</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">count</span><span class="p">)}</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">factors</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span>
      <span class="n">end</span>

      <span class="n">factors</span><span class="p">.</span><span class="n">sort_by</span><span class="o">!</span> <span class="p">{</span> <span class="o">|</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span><span class="o">|</span> <span class="n">factor</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">find_factor</span><span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="cp"># Factor of 4 cannot be discovered by Pollard's Rho with f(x) = x^x+1
</span>      <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="n">typeof</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">pollard_rho</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">not_nil</span><span class="o">!</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Get single factor by Pollard's Rho Algorithm
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">pollard_rho</span><span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">typeof</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">upto</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pollard_random_f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">loop</span> <span class="k">do</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">pollard_random_f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">pollard_random_f</span><span class="p">(</span><span class="n">pollard_random_f</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
          <span class="n">gcd</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">).</span><span class="n">gcd</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">gcd</span> <span class="o">==</span> <span class="n">n</span>
            <span class="k">break</span>
          <span class="n">end</span>

          <span class="k">if</span> <span class="n">gcd</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">gcd</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">pollard_random_f</span><span class="p">(</span><span class="n">n</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">mod</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="p">(</span><span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">mul_mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">extract_prime_division_base</span><span class="p">(</span><span class="n">prime_divisions_class</span> <span class="o">:</span> <span class="n">Array</span><span class="p">({</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">}).</span><span class="k">class</span><span class="p">)</span> <span class="n">forall</span> <span class="n">T</span>
      <span class="n">T</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">int_from_prime_division</span><span class="p">(</span><span class="n">prime_divisions</span> <span class="o">:</span> <span class="n">Array</span><span class="p">({</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">}))</span>
      <span class="n">int_class</span> <span class="o">=</span> <span class="n">extract_prime_division_base</span><span class="p">(</span><span class="n">prime_divisions</span><span class="p">.</span><span class="k">class</span><span class="p">)</span>
      <span class="n">prime_divisions</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">int_class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">exponent</span><span class="p">)</span><span class="o">|</span> <span class="n">i</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">**</span> <span class="n">exponent</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">prime</span><span class="o">?</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="cp"># Obvious patterns
</span>      <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">2</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">3</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">even</span><span class="o">?</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">9</span>

      <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mh">0xffff</span>
        <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="nf">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="n">gcd</span><span class="p">(</span><span class="n">value</span> <span class="o">%</span> <span class="mi">30</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="mf">7.</span><span class="n">step</span><span class="p">(</span><span class="n">by</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">base</span><span class="o">|</span>
          <span class="k">break</span> <span class="k">if</span> <span class="n">base</span> <span class="o">*</span> <span class="n">base</span> <span class="o">&gt;</span> <span class="n">value</span>

          <span class="k">if</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">}.</span><span class="n">any</span><span class="o">?</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">value</span> <span class="o">%</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">}</span>
            <span class="k">return</span> <span class="nb">false</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="k">return</span> <span class="nb">true</span>
      <span class="n">end</span>

      <span class="n">miller_rabin</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">to_i64</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">miller_rabin</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="n">until</span> <span class="n">d</span><span class="p">.</span><span class="n">odd</span><span class="o">?</span>
        <span class="n">d</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="n">miller_rabin_bases</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">base</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">value</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">pow_mod</span><span class="p">(</span><span class="n">base</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">is_composite</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">times</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="k">do</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">mul_mod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
          <span class="n">x</span> <span class="o">!=</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">end</span>

        <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">is_composite</span>
      <span class="n">end</span>

      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># We can reduce time complexity of Miller-Rabin tests by testing against
</span>    <span class="cp"># predefined bases which is enough to test against primarity in the given range.
</span>    <span class="cp"># https://en.wikipedia.org/wiki/Miller%E2%80%93Rabin_primality_test
</span>    <span class="cp"># ameba:disable Metrics/CyclomaticComplexity
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">miller_rabin_bases</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">case</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">_373_653_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="n">_080_191_i64</span>
        <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">73</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="n">_326_001_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="n">_215_031_751_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="n">_759_123_141_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">61</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">_122_004_669_633_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1662803</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="n">_152_302_898_747_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="n">_474_749_660_383_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">341</span><span class="n">_550_071_728_321_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span>
      <span class="n">when</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="n">_825_123_056_546_413_051_i64</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">37</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">get_nth_prime</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="k">while</span> <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">n</span>
        <span class="n">generate_primes</span>
      <span class="n">end</span>

      <span class="err">@@</span><span class="n">primes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="cp"># Doubles the size of the cached prime array and performs the
</span>    <span class="cp"># Sieve of Eratosthenes on it.
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">generate_primes</span>
      <span class="n">new_primes_size</span> <span class="o">=</span> <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="n">_000_000</span> <span class="o">?</span> <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">size</span> <span class="p">:</span> <span class="mi">1</span><span class="n">_000_000</span>
      <span class="n">new_primes</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">new_primes_size</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">last</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">}</span>
      <span class="n">new_primes_max</span> <span class="o">=</span> <span class="n">new_primes</span><span class="p">.</span><span class="n">last</span>

      <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prime</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">prime</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">&gt;</span> <span class="n">new_primes_max</span>

        <span class="cp"># Here I use the technique of the Sieve of Sundaram. We can
</span>        <span class="cp"># only test against the odd multiple of the given prime.
</span>        <span class="cp"># min_composite is the minimum number that is greater than
</span>        <span class="cp"># the last confirmed prime, and is an odd multiple of
</span>        <span class="cp"># the given prime.
</span>        <span class="n">min_multiple</span> <span class="o">=</span> <span class="p">((</span><span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">last</span> <span class="c1">// prime + 1) // 2 * 2 + 1) * prime</span>
        <span class="n">min_multiple</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">by</span><span class="o">:</span> <span class="n">prime</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">new_primes_max</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">multiple</span><span class="o">|</span>
          <span class="n">index</span> <span class="o">=</span> <span class="n">new_primes_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">new_primes_max</span> <span class="o">-</span> <span class="n">multiple</span><span class="p">)</span> <span class="c1">// 2 - 1</span>
          <span class="n">new_primes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@@</span><span class="n">primes</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_primes</span><span class="p">.</span><span class="n">reject</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="k">struct</span> <span class="nf">EachDivisor</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
      <span class="n">include</span> <span class="n">Enumerable</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

      <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">exponential_factors</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">)))</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">each</span>
        <span class="n">Array</span><span class="p">.</span><span class="n">each_product</span><span class="p">(</span><span class="err">@</span><span class="n">exponential_factors</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">factors</span><span class="o">|</span>
          <span class="n">yield</span> <span class="n">factors</span><span class="p">.</span><span class="n">reduce</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="p">}</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Returns an enumerator that iterates through the all positive divisors of
</span>    <span class="cp"># the given number. **The order is not guaranteed.**
</span>    <span class="cp"># Not in the original Ruby's Prime library.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># AtCoder::Prime.each_divisor(20) do |n|
</span>    <span class="cp">#   puts n
</span>    <span class="cp"># end # =&gt; Puts 1, 2, 4, 5, 10, and 20
</span>    <span class="cp">#
</span>    <span class="cp"># AtCoder::Prime.each_divisor(10).map { |n| 1.0 / n }.to_a # =&gt; [1.0, 0.5, 0.2, 0.1]
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">each_divisor</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span> <span class="n">unless</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>

      <span class="n">factors</span> <span class="o">=</span> <span class="n">prime_division</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">exponential_factors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">value</span><span class="p">]]</span>
      <span class="k">else</span>
        <span class="n">exponential_factors</span> <span class="o">=</span> <span class="n">factors</span><span class="p">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span><span class="o">|</span>
          <span class="n">cnt</span> <span class="o">=</span> <span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">zero</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="n">Array</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
            <span class="n">cnt_copy</span> <span class="o">=</span> <span class="n">cnt</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span>
              <span class="n">cnt</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">end</span>
            <span class="n">cnt_copy</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">EachDivisor</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">value</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="n">exponential_factors</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">each_divisor</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">T</span> <span class="o">-&gt;</span><span class="p">)</span>
      <span class="n">each_divisor</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="k">struct</span> <span class="nc">Int</span>
  <span class="n">def</span> <span class="n">prime</span><span class="o">?</span>
    <span class="n">AtCoder</span><span class="o">::</span><span class="n">Prime</span><span class="p">.</span><span class="n">prime</span><span class="o">?</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [ACL's Math library](https://atcoder.github.io/ac-library/master/document_en/math.html)
</span>  <span class="n">module</span> <span class="n">Math</span>
    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">extended_gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">last_remainder</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">abs</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">last_x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">last_y</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">1</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="k">while</span> <span class="n">remainder</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">new_last_remainder</span> <span class="o">=</span> <span class="n">remainder</span>
        <span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">last_remainder</span><span class="p">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">remainder</span><span class="p">)</span>
        <span class="n">last_remainder</span> <span class="o">=</span> <span class="n">new_last_remainder</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">last_x</span> <span class="o">=</span> <span class="n">last_x</span> <span class="o">-</span> <span class="n">quotient</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">last_y</span> <span class="o">=</span> <span class="n">last_y</span> <span class="o">-</span> <span class="n">quotient</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span>
      <span class="n">end</span>

      <span class="k">return</span> <span class="n">last_remainder</span><span class="p">,</span> <span class="n">last_x</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::inv_mod(value, modulo).
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">inv_mod</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
      <span class="n">gcd</span><span class="p">,</span> <span class="n">inv</span> <span class="o">=</span> <span class="n">extended_gcd</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">gcd</span> <span class="o">!=</span> <span class="mi">1</span>
        <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"#{value} and #{modulo} are not coprime"</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="n">inv</span> <span class="o">%</span> <span class="n">modulo</span>
    <span class="n">end</span>

    <span class="cp"># Simplified AtCoder::Math.pow_mod with support of Int64
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">pow_mod</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">exponent</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">base</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="n">zero</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">end</span>
      <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">base</span>
      <span class="n">end</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">exponent</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">base</span> <span class="o">:</span> <span class="n">inv_mod</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
      <span class="n">e</span> <span class="o">=</span> <span class="n">exponent</span><span class="p">.</span><span class="n">abs</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span>
      <span class="k">while</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
          <span class="n">ret</span> <span class="o">=</span> <span class="n">mul_mod</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">mul_mod</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
        <span class="n">e</span> <span class="c1">//= 2</span>
      <span class="n">end</span>
      <span class="n">ret</span>
    <span class="n">end</span>

    <span class="cp"># Caluculates a * b % mod without overflow detection
</span>    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">mul_mod</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">mod</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">mod</span> <span class="o">&lt;</span> <span class="n">Int32</span><span class="o">::</span><span class="n">MAX</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">%</span> <span class="n">mod</span>
      <span class="n">end</span>

      <span class="cp"># 31-bit width
</span>      <span class="n">a_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">).</span><span class="n">to_u64</span>
      <span class="cp"># 32-bit width
</span>      <span class="n">a_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">).</span><span class="n">to_u64</span>
      <span class="cp"># 31-bit width
</span>      <span class="n">b_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">).</span><span class="n">to_u64</span>
      <span class="cp"># 32-bit width
</span>      <span class="n">b_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">).</span><span class="n">to_u64</span>

      <span class="cp"># 31-bit + 32-bit + 1-bit = 64-bit
</span>      <span class="n">c</span> <span class="o">=</span> <span class="n">a_high</span> <span class="o">*</span> <span class="n">b_low</span> <span class="o">+</span> <span class="n">b_high</span> <span class="o">*</span> <span class="n">a_low</span>
      <span class="n">c_high</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>
      <span class="n">c_low</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

      <span class="cp"># 31-bit + 31-bit
</span>      <span class="n">res_high</span> <span class="o">=</span> <span class="n">a_high</span> <span class="o">*</span> <span class="n">b_high</span> <span class="o">+</span> <span class="n">c_high</span>
      <span class="cp"># 32-bit + 32-bit
</span>      <span class="n">res_low</span> <span class="o">=</span> <span class="n">a_low</span> <span class="o">*</span> <span class="n">b_low</span>
      <span class="n">res_low_high</span> <span class="o">=</span> <span class="n">res_low</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>
      <span class="n">res_low_low</span> <span class="o">=</span> <span class="n">res_low</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>

      <span class="cp"># Overflow
</span>      <span class="k">if</span> <span class="n">res_low_high</span> <span class="o">+</span> <span class="n">c_low</span> <span class="o">&gt;=</span> <span class="mh">0x100000000</span>
        <span class="n">res_high</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="n">res_low</span> <span class="o">=</span> <span class="p">(((</span><span class="n">res_low_high</span> <span class="o">+</span> <span class="n">c_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">res_low_low</span>

      <span class="p">(((</span><span class="n">res_high</span><span class="p">.</span><span class="n">to_i128</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">|</span> <span class="n">res_low</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span><span class="p">).</span><span class="n">to_i64</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">mul_mod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
      <span class="n">typeof</span><span class="p">(</span><span class="n">mod</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">*</span> <span class="n">b</span> <span class="o">%</span> <span class="n">mod</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::crt(remainders, modulos).
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">crt</span><span class="p">(</span><span class="n">remainders</span><span class="p">,</span> <span class="n">modulos</span><span class="p">)</span>
      <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span> <span class="n">unless</span> <span class="n">remainders</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">modulos</span><span class="p">.</span><span class="n">size</span>

      <span class="n">total_modulo</span> <span class="o">=</span> <span class="mi">1</span><span class="n">_i64</span>
      <span class="n">answer</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="n">remainders</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">modulos</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span><span class="o">|</span>
        <span class="n">gcd</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">extended_gcd</span><span class="p">(</span><span class="n">total_modulo</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">-</span> <span class="n">answer</span><span class="p">)</span> <span class="o">%</span> <span class="n">gcd</span> <span class="o">!=</span> <span class="mi">0</span>
          <span class="k">return</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span>
        <span class="n">end</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">remainder</span> <span class="o">-</span> <span class="n">answer</span><span class="p">)</span> <span class="c1">// gcd * p % (modulo // gcd)</span>
        <span class="n">answer</span> <span class="o">+=</span> <span class="n">total_modulo</span> <span class="o">*</span> <span class="n">tmp</span>
        <span class="n">total_modulo</span> <span class="o">*=</span> <span class="n">modulo</span> <span class="c1">// gcd</span>
      <span class="n">end</span>

      <span class="k">return</span> <span class="n">answer</span> <span class="o">%</span> <span class="n">total_modulo</span><span class="p">,</span> <span class="n">total_modulo</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::floor_sum(n, m, a, b).
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">floor_sum</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2 * ((a2 - a) // m)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a2</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">((</span><span class="n">b2</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="c1">// m)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b2</span>
      <span class="n">end</span>

      <span class="n">res</span> <span class="o">+</span> <span class="n">floor_sum_unsigned</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">floor_sum_unsigned</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="n">loop</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">m</span>
          <span class="n">res</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2 * (a // m)</span>
          <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">end</span>

        <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="n">m</span>
          <span class="n">res</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="c1">// m)</span>
          <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">end</span>

        <span class="n">y_max</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">b</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">y_max</span> <span class="o">&lt;</span> <span class="n">m</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">y_max</span> <span class="c1">// m</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">%</span> <span class="n">m</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">m</span>
      <span class="n">end</span>

      <span class="n">res</span>
    <span class="n">end</span>

    <span class="cp"># Returns `a * b &gt; target`, without concern of overflows.
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">product_greater_than</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">target</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">target</span> <span class="c1">// b &lt; a</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">get_primitive_root</span><span class="p">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">1</span><span class="n">_i64</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">2</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="n">factors</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Prime</span><span class="p">.</span><span class="n">prime_division</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
      <span class="p">(</span><span class="mi">2</span><span class="n">_i64</span><span class="p">..</span><span class="n">p</span><span class="p">.</span><span class="n">to_i64</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">factors</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">pow_mod</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">n</span> <span class="c1">// factor, p) == 1</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span>
            <span class="k">break</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="k">if</span> <span class="n">ok</span>
          <span class="k">return</span> <span class="n">g</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::mf_graph](https://atcoder.github.io/ac-library/master/document_en/maxflow.html).
</span>  <span class="cp"># `Cap` is always `Int64`.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># mf = AtCoder::MaxFlow.new(3)
</span>  <span class="cp"># mf.add_edge(0, 1, 3)
</span>  <span class="cp"># mf.add_edge(1, 2, 1)
</span>  <span class="cp"># mf.add_edge(0, 2, 2)
</span>  <span class="cp"># mf.flow(0, 2) # =&gt; 3
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">MaxFlow</span>
    <span class="k">class</span> <span class="nc">Edge</span>
      <span class="n">getter</span> <span class="n">to</span> <span class="o">:</span> <span class="n">Int64</span>
      <span class="n">getter</span> <span class="n">reverse_index</span> <span class="o">:</span> <span class="n">Int64</span>
      <span class="n">property</span> <span class="n">capacity</span> <span class="o">:</span> <span class="n">Int64</span>

      <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">to</span><span class="p">,</span> <span class="err">@</span><span class="n">capacity</span><span class="p">,</span> <span class="err">@</span><span class="n">reverse_index</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Number of nodes
</span>    <span class="n">getter</span> <span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>

    <span class="cp"># Adjacency list
</span>    <span class="n">getter</span> <span class="n">adjacencies</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="n">Edge</span><span class="p">))</span>

    <span class="n">getter</span> <span class="n">depths</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>

    <span class="cp"># Number of visited adjacencies for each nodes
</span>    <span class="n">getter</span> <span class="n">visit_counts</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">adjacencies</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Array</span><span class="p">(</span><span class="n">Edge</span><span class="p">)).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Edge</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">depths</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">visit_counts</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mf_graph.add_edge(from, to, capacity).
</span>    <span class="n">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span>
      <span class="n">from_index</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="n">to_index</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">to_i64</span>

      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">Edge</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">capacity</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">to_index</span><span class="p">)</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">Edge</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">from</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="n">from_index</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mf_graph.flow(start, target).
</span>    <span class="n">def</span> <span class="n">flow</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
      <span class="n">flow</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">bfs</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="k">return</span> <span class="n">flow</span>
        <span class="n">end</span>

        <span class="err">@</span><span class="n">visit_counts</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">flowed</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">Int64</span><span class="o">::</span><span class="n">MAX</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="n">flow</span> <span class="o">+=</span> <span class="n">flowed</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">min_cut</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">get_edge</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">edges</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">change_edge</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">bfs</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
      <span class="err">@</span><span class="n">depths</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">queue</span> <span class="o">=</span> <span class="n">Deque</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>

      <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="n">start</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="n">until</span> <span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">shift</span>

        <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">node</span><span class="p">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">edge</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">edge</span><span class="p">.</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">to</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="n">edge</span><span class="p">.</span><span class="n">to</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">flow</span> <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">target</span>

      <span class="n">edges</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
      <span class="k">while</span> <span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edges</span><span class="p">.</span><span class="n">size</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">edge</span><span class="p">.</span><span class="n">capacity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">depths</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">to</span><span class="p">]</span>
          <span class="n">flowed</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">to</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">edge</span><span class="p">.</span><span class="n">capacity</span><span class="p">))</span>

          <span class="k">if</span> <span class="n">flowed</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">edge</span><span class="p">.</span><span class="n">capacity</span> <span class="o">-=</span> <span class="n">flowed</span>
            <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">to</span><span class="p">][</span><span class="n">edge</span><span class="p">.</span><span class="n">reverse_index</span><span class="p">].</span><span class="n">capacity</span> <span class="o">+=</span> <span class="n">flowed</span>
            <span class="k">return</span> <span class="n">flowed</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="mi">0</span><span class="n">_i64</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">b</span> <span class="o">:</span> <span class="n">a</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./graph.cr"
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::mcf_graph](https://atcoder.github.io/ac-library/master/document_en/mincostflow.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># flow = AtCoder::MinCostFlow.new(5)
</span>  <span class="cp"># flow.add_edge(0, 1, 30, 3)
</span>  <span class="cp"># flow.add_edge(0, 2, 60, 9)
</span>  <span class="cp"># flow.add_edge(1, 2, 40, 5)
</span>  <span class="cp"># flow.add_edge(1, 3, 50, 7)
</span>  <span class="cp"># flow.add_edge(2, 3, 20, 8)
</span>  <span class="cp"># flow.add_edge(2, 4, 50, 6)
</span>  <span class="cp"># flow.add_edge(3, 4, 60, 7)
</span>  <span class="cp"># flow.flow(0, 4, 70) # =&gt; {70, 1080}
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">MinCostFlow</span>
    <span class="k">private</span> <span class="n">record</span> <span class="n">EdgeInfo</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">cost</span> <span class="o">:</span> <span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span> <span class="k">do</span>
      <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">zero</span>
        <span class="nf">new</span><span class="p">(</span><span class="n">Int64</span><span class="o">::</span><span class="n">MAX</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">+</span><span class="p">(</span><span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span><span class="p">)</span>
        <span class="n">from_cost</span> <span class="o">=</span> <span class="err">@</span><span class="n">cost</span>
        <span class="n">to_cost</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">cost</span>
        <span class="k">if</span> <span class="n">from_cost</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">to_cost</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
          <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="err">@</span><span class="n">capacity</span><span class="p">,</span> <span class="n">edge</span><span class="p">.</span><span class="n">capacity</span><span class="p">),</span> <span class="n">from_cost</span> <span class="o">+</span> <span class="n">to_cost</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">edge</span> <span class="o">:</span> <span class="n">EdgeInfo</span><span class="p">)</span>
        <span class="n">from_dist</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="n">to_dist</span> <span class="o">=</span> <span class="n">edge</span><span class="p">.</span><span class="n">dist</span>

        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">from_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">to_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

        <span class="n">from_dist</span> <span class="o">&gt;</span> <span class="n">to_dist</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">dist</span>
        <span class="k">return</span> <span class="n">nil</span> <span class="k">if</span> <span class="err">@</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="err">@</span><span class="n">cost</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
      <span class="k">private</span> <span class="n">def</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">b</span> <span class="o">:</span> <span class="n">a</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mcf_graph g(n).
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">graph</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">DirectedGraph</span><span class="p">(</span><span class="n">Nil</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">dists</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="p">{</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mcf_graph.add_edge(from, to, capacity, cost).
</span>    <span class="n">def</span> <span class="n">add_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
      <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">capacity</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">cost</span><span class="p">.</span><span class="n">to_i64</span><span class="p">))</span>
      <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="o">-</span><span class="n">cost</span><span class="p">.</span><span class="n">to_i64</span><span class="p">))</span>
      <span class="err">@</span><span class="n">edges</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">from</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">to</span><span class="p">.</span><span class="n">to_i64</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">increment_edge_cost</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">cost_diff</span><span class="p">)</span>
      <span class="n">edge</span> <span class="o">=</span> <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
      <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">update_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">edge</span> <span class="o">+</span> <span class="n">EdgeInfo</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">capacity</span><span class="p">,</span> <span class="n">cost_diff</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">increment_edge_capacity</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">capacity_diff</span><span class="p">)</span>
      <span class="n">edge</span> <span class="o">=</span> <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
      <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">update_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">EdgeInfo</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">capacity</span> <span class="o">+</span> <span class="n">capacity_diff</span><span class="p">,</span> <span class="n">edge</span><span class="p">.</span><span class="n">cost</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mcf_graph.slope(start, target, flow_limit).
</span>    <span class="cp"># ameba:disable Metrics/CyclomaticComplexity
</span>    <span class="n">def</span> <span class="n">slope</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">flow_limit</span> <span class="o">:</span> <span class="n">Int</span> <span class="o">|</span> <span class="n">Nil</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"start and target cannot be the same"</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">target</span>

      <span class="n">flow_points</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="p">{</span><span class="n">Int64</span><span class="p">,</span> <span class="n">Int64</span><span class="p">}</span>

      <span class="n">current_cost</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="n">flowed_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="n">min_cost</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>

      <span class="n">until</span> <span class="n">flowed_capacity</span> <span class="o">==</span> <span class="n">flow_limit</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="err">@</span><span class="n">graph</span><span class="p">.</span><span class="n">dijkstra</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="n">target_dist</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="o">:</span><span class="n">dist</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">target_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">target_dist</span><span class="p">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="k">break</span>
        <span class="n">end</span>

        <span class="n">capacity</span> <span class="o">=</span> <span class="n">target_dist</span><span class="p">.</span><span class="n">capacity</span>

        <span class="cp"># Update edge capacities on the path from start to target
</span>        <span class="n">last_node</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">until</span> <span class="n">last_node</span> <span class="o">==</span> <span class="n">start</span>
          <span class="n">prev_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">last_node</span><span class="p">][</span><span class="o">:</span><span class="n">prev</span><span class="p">].</span><span class="n">not_nil</span><span class="o">!</span>

          <span class="n">increment_edge_capacity</span><span class="p">(</span><span class="n">prev_node</span><span class="p">,</span> <span class="n">last_node</span><span class="p">,</span> <span class="o">-</span><span class="n">capacity</span><span class="p">)</span>
          <span class="n">increment_edge_capacity</span><span class="p">(</span><span class="n">last_node</span><span class="p">,</span> <span class="n">prev_node</span><span class="p">,</span> <span class="n">capacity</span><span class="p">)</span>

          <span class="n">last_node</span> <span class="o">=</span> <span class="n">prev_node</span>
        <span class="n">end</span>

        <span class="cp"># Update edge costs
</span>        <span class="err">@</span><span class="n">edges</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="o">|</span>
          <span class="n">from_dist</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">from</span><span class="p">][</span><span class="o">:</span><span class="n">dist</span><span class="p">]</span>
          <span class="n">to_dist</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">to</span><span class="p">][</span><span class="o">:</span><span class="n">dist</span><span class="p">]</span>

          <span class="n">next</span> <span class="k">if</span> <span class="n">from_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">to_dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
          <span class="n">next</span> <span class="k">if</span> <span class="n">from_dist</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">to_dist</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

          <span class="n">dist</span> <span class="o">=</span> <span class="n">to_dist</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span> <span class="o">-</span> <span class="n">from_dist</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>

          <span class="n">increment_edge_cost</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="o">-</span><span class="n">dist</span><span class="p">)</span>
          <span class="n">increment_edge_cost</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="cp"># Update distants
</span>        <span class="n">nodes</span><span class="p">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
          <span class="n">dist</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="o">:</span><span class="n">dist</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">dist</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="err">@</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">dist</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
            <span class="err">@</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nil</span>
          <span class="k">else</span>
            <span class="err">@</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">not_nil</span><span class="o">!</span> <span class="o">+</span> <span class="n">dist</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">.</span><span class="n">cost</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="n">new_cost</span> <span class="o">=</span> <span class="err">@</span><span class="n">dists</span><span class="p">[</span><span class="n">target</span><span class="p">].</span><span class="n">not_nil</span><span class="o">!</span>
        <span class="k">if</span> <span class="n">flow_limit</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
          <span class="n">new_capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="k">else</span>
          <span class="n">new_capacity</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">flow_limit</span> <span class="o">-</span> <span class="n">flowed_capacity</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="k">if</span> <span class="n">new_cost</span> <span class="o">!=</span> <span class="n">current_cost</span>
          <span class="k">if</span> <span class="n">current_cost</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flowed_capacity</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">flow_points</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="mi">0</span><span class="n">_i64</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">}</span>
          <span class="n">end</span>
          <span class="n">flow_points</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">flowed_capacity</span><span class="p">,</span> <span class="n">min_cost</span><span class="p">}</span>
        <span class="n">end</span>

        <span class="n">min_cost</span> <span class="o">+=</span> <span class="n">new_cost</span> <span class="o">*</span> <span class="n">new_capacity</span>
        <span class="n">flowed_capacity</span> <span class="o">+=</span> <span class="n">new_capacity</span>
        <span class="n">current_cost</span> <span class="o">=</span> <span class="n">new_cost</span>
      <span class="n">end</span>

      <span class="n">flow_points</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">flowed_capacity</span><span class="p">,</span> <span class="n">min_cost</span><span class="p">}</span>

      <span class="n">flow_points</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::mcf_graph.flow(start, target, flow_limit).
</span>    <span class="n">def</span> <span class="n">flow</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">flow_limit</span> <span class="o">:</span> <span class="n">Int</span> <span class="o">|</span> <span class="n">Nil</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="n">flow_points</span> <span class="o">=</span> <span class="n">slope</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">flow_limit</span><span class="p">)</span>
      <span class="n">flow_points</span><span class="p">.</span><span class="n">last</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">b</span> <span class="o">:</span> <span class="n">a</span>
    <span class="n">end</span>

    <span class="n">delegate</span> <span class="o">:</span><span class="n">size</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">graph</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./math.cr"
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::static_modint](https://atcoder.github.io/ac-library/master/document_en/modint.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># AtCoder.static_modint(ModInt101, 101_i64)
</span>  <span class="cp"># alias Mint = AtCoder::ModInt101
</span>  <span class="cp"># Mint.new(80_i64) + Mint.new(90_i64) # =&gt; 89
</span>  <span class="cp"># ```
</span>  <span class="n">macro</span> <span class="nf">static_modint</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">modulo</span><span class="p">)</span>
    <span class="n">module</span> <span class="n">AtCoder</span>
      <span class="cp"># Implements atcoder::modint{{modulo}}.
</span>      <span class="cp">#
</span>      <span class="cp"># ```
</span>      <span class="cp"># alias Mint = AtCoder::{{name}}
</span>      <span class="cp"># Mint.new(30_i64) // Mint.new(7_i64)
</span>      <span class="cp"># ```
</span>      <span class="k">struct</span> <span class="p">{{</span><span class="n">name</span><span class="p">}}</span>
        <span class="n">MOD</span> <span class="o">=</span> <span class="p">{{</span><span class="n">modulo</span><span class="p">}}</span>

        <span class="n">getter</span> <span class="n">value</span> <span class="o">:</span> <span class="n">Int64</span>

        <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="err">@</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">%</span> <span class="n">MOD</span>
        <span class="n">end</span>

        <span class="cp"># Change the initial capacity of this array to improve performance
</span>        <span class="err">@@</span><span class="n">factorials</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="mi">100</span><span class="n">_000_i64</span><span class="p">)</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
          <span class="k">if</span> <span class="err">@@</span><span class="n">factorials</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
            <span class="err">@@</span><span class="n">factorials</span> <span class="o">&lt;&lt;</span> <span class="n">self</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
          <span class="n">end</span>
          <span class="err">@@</span><span class="n">factorials</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">upto</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
            <span class="err">@@</span><span class="n">factorials</span> <span class="o">&lt;&lt;</span> <span class="err">@@</span><span class="n">factorials</span><span class="p">.</span><span class="n">last</span> <span class="o">*</span> <span class="n">i</span>
          <span class="n">end</span>
          <span class="err">@@</span><span class="n">factorials</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"k cannot be greater than n"</span><span class="p">)</span> <span class="n">unless</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">k</span>
          <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1">// factorial(n - k)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">combination</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"k cannot be greater than n"</span><span class="p">)</span> <span class="n">unless</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">k</span>
          <span class="n">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c1">// @@factorials[k]</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">repeated_combination</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">combination</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">zero</span>
          <span class="n">self</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">inv</span>
          <span class="n">g</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">extended_gcd</span><span class="p">(</span><span class="err">@</span><span class="n">value</span><span class="p">,</span> <span class="n">MOD</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">+</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">value</span> <span class="o">+</span> <span class="n">value</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">%</span> <span class="n">MOD</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">-</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">value</span> <span class="o">-</span> <span class="n">value</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">%</span> <span class="n">MOD</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">*</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">%</span> <span class="n">MOD</span><span class="p">))</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">/</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">self</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">DivisionByZeroError</span><span class="p">.</span><span class="k">new</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="n">self</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">inv</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">/</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">DivisionByZeroError</span><span class="p">.</span><span class="k">new</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="n">self</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">to_i64</span><span class="p">).</span><span class="n">inv</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="c1">//(value)</span>
          <span class="n">self</span><span class="p">.</span><span class="o">/</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">**</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">AtCoder</span><span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">pow_mod</span><span class="p">(</span><span class="err">@</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">to_i64</span><span class="p">,</span> <span class="n">MOD</span><span class="p">))</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">2</span><span class="n">_i64</span><span class="p">)</span> <span class="o">**</span> <span class="n">value</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">sqrt</span>
          <span class="n">z</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">1</span><span class="n">_i64</span><span class="p">)</span>
          <span class="n">until</span> <span class="n">z</span> <span class="o">**</span> <span class="p">((</span><span class="n">MOD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2) == MOD - 1</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">end</span>
          <span class="n">q</span> <span class="o">=</span> <span class="n">MOD</span> <span class="o">-</span> <span class="mi">1</span>
          <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="k">while</span> <span class="n">q</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">q</span> <span class="c1">//= 2</span>
            <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">end</span>
          <span class="n">c</span> <span class="o">=</span> <span class="n">z</span> <span class="o">**</span> <span class="n">q</span>
          <span class="n">t</span> <span class="o">=</span> <span class="n">self</span> <span class="o">**</span> <span class="n">q</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">self</span> <span class="o">**</span> <span class="p">((</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2)</span>
          <span class="n">m</span><span class="p">.</span><span class="n">downto</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">t</span> <span class="o">**</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="mi">1</span>
              <span class="n">r</span> <span class="o">*=</span> <span class="n">c</span>
              <span class="n">t</span> <span class="o">*=</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">end</span>
            <span class="n">c</span> <span class="o">*=</span> <span class="n">c</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span> <span class="o">==</span> <span class="n">self</span>
            <span class="n">r</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">MOD</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="o">-</span><span class="n">r</span>
          <span class="k">else</span>
            <span class="n">nil</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">to_i64</span>
          <span class="err">@</span><span class="n">value</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">==</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">self</span><span class="p">)</span>
          <span class="err">@</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">.</span><span class="n">to_i64</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">==</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="err">@</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">-</span>
          <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">0</span><span class="n">_i64</span><span class="p">)</span> <span class="o">-</span> <span class="n">self</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="o">+</span>
          <span class="n">self</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">abs</span>
          <span class="n">self</span>
        <span class="n">end</span>

        <span class="cp"># ac-library compatibility
</span>
        <span class="n">def</span> <span class="n">pow</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">self</span><span class="p">.</span><span class="o">**</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">def</span> <span class="n">val</span>
          <span class="n">self</span><span class="p">.</span><span class="n">to_i64</span>
        <span class="n">end</span>

        <span class="cp"># ModInt shouldn't be compared
</span>
        <span class="n">def</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"&lt;"</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">def</span> <span class="o">&lt;=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"&lt;="</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">def</span> <span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">def</span> <span class="o">&gt;=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"&gt;="</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">value</span>
        <span class="n">delegate</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">value</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">struct</span> <span class="nc">Int</span>
      <span class="n">def</span> <span class="o">+</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">AtCoder</span><span class="o">::</span><span class="p">{{</span><span class="n">name</span><span class="p">}})</span>
        <span class="n">value</span> <span class="o">+</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">-</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">AtCoder</span><span class="o">::</span><span class="p">{{</span><span class="n">name</span><span class="p">}})</span>
        <span class="o">-</span><span class="n">value</span> <span class="o">+</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">*</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">AtCoder</span><span class="o">::</span><span class="p">{{</span><span class="n">name</span><span class="p">}})</span>
        <span class="n">value</span> <span class="o">*</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="c1">//(value : AtCoder::{{name}})</span>
        <span class="n">value</span><span class="p">.</span><span class="n">inv</span> <span class="o">*</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">/</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">AtCoder</span><span class="o">::</span><span class="p">{{</span><span class="n">name</span><span class="p">}})</span>
        <span class="n">self</span> <span class="c1">// value</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="o">==</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">AtCoder</span><span class="o">::</span><span class="p">{{</span><span class="n">name</span><span class="p">}})</span>
        <span class="n">value</span> <span class="o">==</span> <span class="n">self</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">AtCoder</span><span class="p">.</span><span class="n">static_modint</span><span class="p">(</span><span class="n">ModInt1000000007</span><span class="p">,</span> <span class="mi">1</span><span class="n">_000_000_007_i64</span><span class="p">)</span>
<span class="n">AtCoder</span><span class="p">.</span><span class="n">static_modint</span><span class="p">(</span><span class="n">ModInt998244353</span><span class="p">,</span> <span class="mi">998</span><span class="n">_244_353_i64</span><span class="p">)</span>
<span class="n">AtCoder</span><span class="p">.</span><span class="n">static_modint</span><span class="p">(</span><span class="n">ModInt754974721</span><span class="p">,</span> <span class="mi">754</span><span class="n">_974_721_i64</span><span class="p">)</span>
<span class="n">AtCoder</span><span class="p">.</span><span class="n">static_modint</span><span class="p">(</span><span class="n">ModInt167772161</span><span class="p">,</span> <span class="mi">167</span><span class="n">_772_161_i64</span><span class="p">)</span>
<span class="n">AtCoder</span><span class="p">.</span><span class="n">static_modint</span><span class="p">(</span><span class="n">ModInt469762049</span><span class="p">,</span> <span class="mi">469</span><span class="n">_762_049_i64</span><span class="p">)</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># bench_red_black_tree.rb by Rubinius Project, (c) Rubinius Contributors
# https://github.com/rubinius/rubinius-benchmark/blob/master/real_world/bench_red_black_tree.rb
# Licensed under BSD License https://spdx.org/licenses/BSD-3-Clause.html
</span>
<span class="cp"># red_black_tree.cr by Crystal Language Project, (c) Manas Technology Solutions
# https://github.com/crystal-lang/crystal/blob/master/samples/red_black_tree.cr
# Licensed under MIT License https://mit-license.org
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="k">class</span> <span class="nc">RedBlackTree</span>
    <span class="k">class</span> <span class="nc">Node</span>
      <span class="n">property</span> <span class="o">:</span><span class="n">color</span>
      <span class="n">property</span> <span class="o">:</span><span class="n">key</span>
      <span class="n">property</span><span class="o">!</span> <span class="o">:</span><span class="n">left</span>
      <span class="n">property</span><span class="o">!</span> <span class="o">:</span><span class="n">right</span>
      <span class="n">property</span><span class="o">!</span> <span class="n">parent</span> <span class="o">:</span> <span class="n">self</span>

      <span class="n">RED</span>   <span class="o">=</span> <span class="o">:</span><span class="n">red</span>
      <span class="n">BLACK</span> <span class="o">=</span> <span class="o">:</span><span class="n">black</span>

      <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">key</span> <span class="o">:</span> <span class="n">Int32</span><span class="p">,</span> <span class="err">@</span><span class="n">color</span> <span class="o">=</span> <span class="n">RED</span><span class="p">)</span>
        <span class="err">@</span><span class="n">left</span> <span class="o">=</span> <span class="err">@</span><span class="n">right</span> <span class="o">=</span> <span class="err">@</span><span class="n">parent</span> <span class="o">=</span> <span class="n">NilNode</span><span class="p">.</span><span class="n">instance</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">black</span><span class="o">?</span>
        <span class="n">color</span> <span class="o">==</span> <span class="n">BLACK</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">red</span><span class="o">?</span>
        <span class="n">color</span> <span class="o">==</span> <span class="n">RED</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">nil_node</span><span class="o">?</span>
        <span class="nb">false</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">class</span> <span class="nc">NilNode</span> <span class="o">&lt;</span> <span class="n">Node</span>
      <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">instance</span>
        <span class="err">@@</span><span class="n">instance</span> <span class="o">||=</span> <span class="n">RedBlackTree</span><span class="o">::</span><span class="n">NilNode</span><span class="p">.</span><span class="k">new</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">initialize</span>
        <span class="err">@</span><span class="n">key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="err">@</span><span class="n">color</span> <span class="o">=</span> <span class="n">BLACK</span>
        <span class="err">@</span><span class="n">left</span> <span class="o">=</span> <span class="err">@</span><span class="n">right</span> <span class="o">=</span> <span class="err">@</span><span class="n">parent</span> <span class="o">=</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">nil_node</span><span class="o">?</span>
        <span class="nb">true</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">include</span> <span class="n">Enumerable</span><span class="p">(</span><span class="n">Int32</span><span class="p">)</span>

    <span class="n">property</span> <span class="n">root</span> <span class="o">:</span> <span class="n">Node</span>
    <span class="n">property</span> <span class="o">:</span><span class="n">size</span>

    <span class="n">def</span> <span class="n">initialize</span>
      <span class="err">@</span><span class="n">root</span> <span class="o">=</span> <span class="n">NilNode</span><span class="p">.</span><span class="n">instance</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="n">insert_node</span><span class="p">(</span><span class="n">Node</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">insert_node</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">insert_helper</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

      <span class="n">x</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
      <span class="k">while</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">root</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">y</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span>
              <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
              <span class="n">left_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">end</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">right_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
          <span class="n">end</span>
        <span class="k">else</span>
          <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">y</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
              <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
              <span class="n">right_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">end</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">left_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">root</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">delete_node</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
      <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">||</span> <span class="n">z</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span><span class="p">)</span> <span class="o">?</span> <span class="n">z</span> <span class="o">:</span> <span class="n">successor</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">?</span> <span class="n">y</span><span class="p">.</span><span class="n">right</span> <span class="o">:</span> <span class="n">y</span><span class="p">.</span><span class="n">left</span>
      <span class="n">x</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">parent</span>

      <span class="k">if</span> <span class="n">y</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">x</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">y</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">else</span>
          <span class="n">y</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">z</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">key</span> <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">z</span>

      <span class="k">if</span> <span class="n">y</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
        <span class="n">delete_fixup</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">self</span><span class="p">.</span><span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="n">y</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">minimum_node</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span>
      <span class="n">end</span>
      <span class="n">x</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">maximum_node</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span>
      <span class="n">end</span>
      <span class="n">x</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">successor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="k">return</span> <span class="n">minimum_node</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">right</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">parent</span>
      <span class="n">end</span>
      <span class="n">y</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">predecessor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="k">return</span> <span class="n">maximum_node</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">left</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">left</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">parent</span>
      <span class="n">end</span>
      <span class="n">y</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">inorder_walk</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="cp"># ameba:disable Lint/ShadowedArgument
</span>      <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">minimum_node</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">yield</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">successor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">each</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="n">inorder_walk</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">yield</span> <span class="n">k</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="nf">reverse_inorder_walk</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="cp"># ameba:disable Lint/ShadowedArgument
</span>      <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">maximum_node</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">yield</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">predecessor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">reverse_each</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="n">reverse_inorder_walk</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">yield</span> <span class="n">k</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span> <span class="o">:</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span>
      <span class="n">end</span>
      <span class="n">x</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">lower_than</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span> <span class="o">:</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span>
        <span class="k">if</span> <span class="n">tmp</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
          <span class="k">return</span> <span class="n">x</span>
        <span class="n">end</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tmp</span>
      <span class="n">end</span>
      <span class="n">x</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">empty</span><span class="o">?</span>
      <span class="n">self</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">black_height</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>
      <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span>
        <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span> <span class="o">||</span> <span class="n">x</span><span class="p">.</span><span class="n">black</span><span class="o">?</span>
      <span class="n">end</span>
      <span class="n">height</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">left_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">raise</span> <span class="s">"x.right is nil!"</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span>
      <span class="n">x</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">left</span>
      <span class="n">y</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
      <span class="n">y</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
      <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">y</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">else</span>
          <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">y</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">x</span>
      <span class="n">x</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">right_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">raise</span> <span class="s">"x.left is nil!"</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span>
      <span class="n">x</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">right</span>
      <span class="n">y</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="o">!</span><span class="n">y</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
      <span class="n">y</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
      <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">y</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">else</span>
          <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">y</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">x</span>
      <span class="n">x</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">insert_helper</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">NilNode</span><span class="p">.</span><span class="n">instance</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">root</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">x</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">x</span><span class="p">.</span><span class="n">left</span> <span class="o">:</span> <span class="n">x</span><span class="p">.</span><span class="n">right</span>
      <span class="n">end</span>
      <span class="n">z</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">y</span>
      <span class="k">if</span> <span class="n">y</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">self</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">z</span>
      <span class="k">else</span>
        <span class="n">z</span><span class="p">.</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">.</span><span class="n">key</span> <span class="o">?</span> <span class="n">y</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">z</span> <span class="o">:</span> <span class="n">y</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">z</span>
      <span class="n">end</span>
      <span class="n">self</span><span class="p">.</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">end</span>

    <span class="cp"># ameba:disable Metrics/CyclomaticComplexity
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">delete_fixup</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">root</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span>
          <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">left_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
              <span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
              <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
              <span class="n">right_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
              <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">right</span>
            <span class="n">end</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">w</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">left_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span>
          <span class="n">end</span>
        <span class="k">else</span>
          <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">right_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">color</span> <span class="o">==</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
              <span class="n">w</span><span class="p">.</span><span class="n">right</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
              <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">RED</span>
              <span class="n">left_rotate</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
              <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">left</span>
            <span class="n">end</span>
            <span class="n">w</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span>
            <span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
            <span class="n">right_rotate</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">x</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">Node</span><span class="o">::</span><span class="n">BLACK</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">min</span>
      <span class="n">minimum_node</span><span class="p">.</span><span class="n">key</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">max</span>
      <span class="n">maximum_node</span><span class="p">.</span><span class="n">key</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="k">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
        <span class="n">delete_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">has_key</span><span class="o">?</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="n">nil_node</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::scc_graph](https://atcoder.github.io/ac-library/master/document_en/scc.html).
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># scc = AtCoder::SCC.new(3_i64)
</span>  <span class="cp"># scc.add_edge(0, 1)
</span>  <span class="cp"># scc.add_edge(1, 0)
</span>  <span class="cp"># scc.add_edge(2, 0)
</span>  <span class="cp"># scc.scc # =&gt; [Set{2}, Set{0, 1}]
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">SCC</span>
    <span class="n">alias</span> <span class="n">Adjacency</span> <span class="o">=</span> <span class="n">NamedTuple</span><span class="p">(</span><span class="n">in</span><span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">),</span> <span class="n">out</span><span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">))</span>

    <span class="n">getter</span> <span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>
    <span class="n">getter</span> <span class="n">adjacencies</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Adjacency</span><span class="p">)</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">adjacencies</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Adjacency</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="p">{</span><span class="n">in</span><span class="o">:</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Int64</span><span class="p">,</span> <span class="n">out</span><span class="o">:</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Int64</span><span class="p">}</span> <span class="p">}</span>

      <span class="err">@</span><span class="n">topological_order</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">visit_counts</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">stack</span> <span class="o">=</span> <span class="n">Deque</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">groups</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">)).</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::scc_graph.add_edge(from, to).
</span>    <span class="n">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">from</span><span class="p">][</span><span class="o">:</span><span class="n">out</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">to</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">to</span><span class="p">][</span><span class="o">:</span><span class="n">in</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">from</span><span class="p">.</span><span class="n">to_i64</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">dfs</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
      <span class="err">@</span><span class="n">stack</span> <span class="o">&lt;&lt;</span> <span class="n">start</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">start</span>

      <span class="n">until</span> <span class="err">@</span><span class="n">stack</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">node</span> <span class="o">=</span> <span class="err">@</span><span class="n">stack</span><span class="p">.</span><span class="n">last</span>
        <span class="n">children</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="o">:</span><span class="n">out</span><span class="p">]</span>

        <span class="k">if</span> <span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">children</span><span class="p">.</span><span class="n">size</span>
          <span class="n">child</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
          <span class="err">@</span><span class="n">visit_counts</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

          <span class="n">unless</span> <span class="err">@</span><span class="n">visited</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="err">@</span><span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
            <span class="err">@</span><span class="n">stack</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
          <span class="n">end</span>
        <span class="k">else</span>
          <span class="err">@</span><span class="n">topological_order</span> <span class="o">&lt;&lt;</span> <span class="n">node</span>
          <span class="err">@</span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">reverse_dfs</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
      <span class="err">@</span><span class="n">stack</span> <span class="o">&lt;&lt;</span> <span class="n">start</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">start</span>
      <span class="n">group</span> <span class="o">=</span> <span class="n">Set</span><span class="p">{</span><span class="n">start</span><span class="p">}</span>

      <span class="n">until</span> <span class="err">@</span><span class="n">stack</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">node</span> <span class="o">=</span> <span class="err">@</span><span class="n">stack</span><span class="p">.</span><span class="n">pop</span>
        <span class="n">children</span> <span class="o">=</span> <span class="err">@</span><span class="n">adjacencies</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="o">:</span><span class="n">in</span><span class="p">]</span>

        <span class="n">children</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span>
          <span class="n">unless</span> <span class="err">@</span><span class="n">visited</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="err">@</span><span class="n">stack</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
            <span class="err">@</span><span class="n">visited</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
            <span class="n">group</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">groups</span> <span class="o">&lt;&lt;</span> <span class="n">group</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::scc_graph.scc().
</span>    <span class="n">def</span> <span class="n">scc</span>
      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">stack</span> <span class="o">=</span> <span class="n">Deque</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>
      <span class="err">@</span><span class="n">visit_counts</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="err">@</span><span class="n">topological_order</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">groups</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">)).</span><span class="k">new</span>

      <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
        <span class="n">unless</span> <span class="err">@</span><span class="n">visited</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
          <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">visited</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span>

      <span class="err">@</span><span class="n">topological_order</span><span class="p">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
        <span class="n">unless</span> <span class="err">@</span><span class="n">visited</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
          <span class="n">reverse_dfs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">groups</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::segtree](https://atcoder.github.io/ac-library/master/document_en/segtree.html).
</span>  <span class="cp">#
</span>  <span class="cp"># The identity element will be implicitly defined as nil, so you don't
</span>  <span class="cp"># have to manually define it. In the other words, you cannot include
</span>  <span class="cp"># nil into an element of the monoid.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># tree = AtCoder::SegTree.new((0...100).to_a) { |a, b| [a, b].min }
</span>  <span class="cp"># tree[10...50] # =&gt; 10
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nf">SegTree</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">property</span> <span class="n">values</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">values</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
      <span class="n">initialize</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">values</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="o">&amp;</span><span class="err">@</span><span class="k">operator</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">)</span>
      <span class="err">@</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
      <span class="err">@</span><span class="n">segments</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="o">::</span><span class="n">Math</span><span class="p">.</span><span class="n">log2</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">).</span><span class="n">ceil</span><span class="p">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>

      <span class="cp"># initialize segments
</span>      <span class="p">(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">downto</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="n">child1</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="n">child2</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
          <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">operate</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">b</span>
      <span class="n">elsif</span> <span class="n">b</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">a</span>
      <span class="k">else</span>
        <span class="err">@</span><span class="k">operator</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.set(index, value)
</span>    <span class="n">def</span> <span class="p">[]</span><span class="o">=</span><span class="p">(</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">value</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

      <span class="n">parent_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2</span>
      <span class="k">while</span> <span class="n">parent_index</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">parent_index</span>
        <span class="n">child1</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="n">child2</span> <span class="o">=</span> <span class="n">nil</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">T</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
          <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child1</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
        <span class="n">parent_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 2</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.get(index)
</span>    <span class="n">def</span> <span class="p">[](</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.prod(l, r)
</span>    <span class="n">def</span> <span class="p">[](</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">exclusive</span><span class="o">?</span> <span class="o">?</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">:</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">get_value</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">..(</span><span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)).</span><span class="n">not_nil</span><span class="o">!</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">get_value</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">segment_index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int</span><span class="p">,</span> <span class="n">Int</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">a</span> <span class="o">||</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
        <span class="k">return</span> <span class="n">nil</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">segment_index</span> <span class="o">&lt;</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">segments</span><span class="p">[</span><span class="n">segment_index</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="err">@</span><span class="n">values</span><span class="p">[</span><span class="n">segment_index</span> <span class="o">-</span> <span class="err">@</span><span class="n">segments</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">range_median</span> <span class="o">=</span> <span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">begin</span> <span class="o">+</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="c1">// 2</span>
      <span class="n">child1</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">segment_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">...</span><span class="n">range_median</span><span class="p">)</span>
      <span class="n">child2</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">segment_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">range_median</span><span class="p">...</span><span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>

      <span class="n">operate</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span> <span class="n">child2</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># compatibility with ac-library
</span>
    <span class="cp"># Implements atcoder::segtree.set(index, value)
</span>    <span class="cp"># alias of `.[]=`
</span>    <span class="n">def</span> <span class="n">set</span><span class="p">(</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">value</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.[]</span><span class="o">=</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.get(index)
</span>    <span class="cp"># alias of `.[]`
</span>    <span class="n">def</span> <span class="n">get</span><span class="p">(</span><span class="n">index</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.[](</span><span class="n">index</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.prod(left, right)
</span>    <span class="n">def</span> <span class="n">prod</span><span class="p">(</span><span class="n">left</span> <span class="o">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">right</span> <span class="o">:</span> <span class="n">Int</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.[](</span><span class="n">left</span><span class="p">...</span><span class="n">right</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::segtree.all_prod(l, r)
</span>    <span class="n">def</span> <span class="n">all_prod</span>
      <span class="n">self</span><span class="p">.[](</span><span class="mf">0.</span><span class="p">..</span><span class="err">@</span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">max_right</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="cp"># FIXME: Unimplemented
</span>    <span class="n">def</span> <span class="n">max_left</span>
      <span class="n">raise</span> <span class="n">NotImplementedError</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="k">class</span> <span class="nf">SkewHeap</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="err">@</span><span class="n">root</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span>
    <span class="err">@</span><span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>

    <span class="n">getter</span> <span class="o">:</span><span class="n">size</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
      <span class="err">@</span><span class="n">left</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span>
      <span class="err">@</span><span class="n">right</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span>
      <span class="err">@</span><span class="n">value</span> <span class="o">:</span> <span class="n">T</span>

      <span class="n">property</span> <span class="o">:</span><span class="n">value</span><span class="p">,</span> <span class="o">:</span><span class="n">left</span><span class="p">,</span> <span class="o">:</span><span class="n">right</span>

      <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">left</span><span class="p">,</span> <span class="err">@</span><span class="n">right</span><span class="p">,</span> <span class="err">@</span><span class="n">value</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">initialize</span>
      <span class="n">initialize</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span> <span class="o">-&gt;</span> <span class="n">Bool</span><span class="p">)</span>
      <span class="err">@</span><span class="n">root</span> <span class="o">=</span> <span class="n">nil</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="n">_i64</span>
      <span class="err">@</span><span class="n">compare_proc</span> <span class="o">=</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">meld</span><span class="p">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">,</span> <span class="n">b</span> <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">|</span> <span class="n">Nil</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
      <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
      <span class="k">if</span> <span class="err">@</span><span class="n">compare_proc</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
      <span class="n">end</span>
      <span class="n">a</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">meld</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">a</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">left</span>
      <span class="n">a</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">push</span><span class="p">(</span><span class="n">value</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="err">@</span><span class="n">root</span> <span class="o">=</span> <span class="n">meld</span><span class="p">(</span><span class="err">@</span><span class="n">root</span><span class="p">,</span> <span class="n">Node</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="n">nil</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">pop</span>
      <span class="k">return</span> <span class="n">nil</span> <span class="k">if</span> <span class="err">@</span><span class="n">root</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
      <span class="n">root</span> <span class="o">=</span> <span class="err">@</span><span class="n">root</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">value</span>
      <span class="err">@</span><span class="n">root</span> <span class="o">=</span> <span class="n">meld</span><span class="p">(</span><span class="n">root</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="n">ret</span>
    <span class="n">end</span>

    <span class="cp"># Alias of `push`
</span>    <span class="n">def</span> <span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">T</span><span class="p">)</span>
      <span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">empty</span><span class="o">?</span>
      <span class="err">@</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License")</span><span class="p">;</span>
<span class="cp"># you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="n">module</span> <span class="n">String</span>
    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">z_algorithm</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">.</span><span class="n">size</span>
      <span class="k">return</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Int32</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
      <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span>
        <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">?</span> <span class="n">j</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">:</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">sequence</span><span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="n">sequence</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
          <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="k">if</span> <span class="n">j</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>
      <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
      <span class="n">z</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># ac-library.cr by hakatashi https://github.com/google/ac-library.cr
#
# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
</span>
<span class="cp"># require "./scc.cr"
</span>
<span class="n">module</span> <span class="n">AtCoder</span>
  <span class="cp"># Implements [atcoder::two_sat](https://atcoder.github.io/ac-library/master/document_en/twosat.html)
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># twosat = AtCoder::TwoSat.new(2_i64)
</span>  <span class="cp"># twosat.add_clause(0, true, 1, false)
</span>  <span class="cp"># twosat.add_clause(1, true, 0, false)
</span>  <span class="cp"># twosat.add_clause(0, false, 1, false)
</span>  <span class="cp"># twosat.satisfiable? # =&gt; true
</span>  <span class="cp"># twosat.answer       # =&gt; [false, false]
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">TwoSat</span>
    <span class="n">getter</span> <span class="n">size</span> <span class="o">:</span> <span class="n">Int64</span>

    <span class="k">class</span> <span class="nc">NotSatisfiableError</span> <span class="o">&lt;</span> <span class="n">Exception</span>
      <span class="n">def</span> <span class="n">initialize</span>
        <span class="n">super</span><span class="p">(</span><span class="s">"The formula is not satisfiable"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">scc</span> <span class="o">=</span> <span class="n">AtCoder</span><span class="o">::</span><span class="n">SCC</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
      <span class="err">@</span><span class="n">solved</span> <span class="o">=</span> <span class="nb">false</span>
      <span class="err">@</span><span class="n">satisfiable</span> <span class="o">=</span> <span class="nb">false</span>
      <span class="err">@</span><span class="n">group_list</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">def</span> <span class="n">var</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">f</span>
        <span class="n">i</span><span class="p">.</span><span class="n">to_i64</span>
      <span class="k">else</span>
        <span class="n">i</span><span class="p">.</span><span class="n">to_i64</span> <span class="o">+</span> <span class="err">@</span><span class="n">size</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::two_sat.add_clause(i, f, j, g).
</span>    <span class="n">def</span> <span class="n">add_clause</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
      <span class="err">@</span><span class="n">scc</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">!</span><span class="n">f</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
      <span class="err">@</span><span class="n">scc</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="o">!</span><span class="n">g</span><span class="p">),</span> <span class="n">var</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::two_sat.satisfiable().
</span>    <span class="n">def</span> <span class="n">satisfiable</span><span class="o">?</span>
      <span class="err">@</span><span class="n">satisfiable</span> <span class="o">=</span> <span class="nb">false</span>

      <span class="n">groups</span> <span class="o">=</span> <span class="err">@</span><span class="n">scc</span><span class="p">.</span><span class="n">scc</span>
      <span class="err">@</span><span class="n">group_list</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Int64</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="n">_i64</span><span class="p">)</span>
      <span class="n">groups</span><span class="p">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="n">group</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="err">@</span><span class="n">group_list</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">to_i64</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">size</span><span class="p">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">group_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="err">@</span><span class="n">group_list</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="err">@</span><span class="n">size</span><span class="p">]</span>
          <span class="k">return</span> <span class="nb">false</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">satisfiable</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># Implements atcoder::two_sat.answer().
</span>    <span class="cp">#
</span>    <span class="cp"># This method will raise `NotSatisfiableError` if it's not satisfiable.
</span>    <span class="n">def</span> <span class="n">answer</span>
      <span class="n">unless</span> <span class="err">@</span><span class="n">satisfiable</span>
        <span class="n">raise</span> <span class="n">NotSatisfiableError</span><span class="p">.</span><span class="k">new</span>
      <span class="n">end</span>

      <span class="n">Array</span><span class="p">(</span><span class="n">Bool</span><span class="p">).</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">size</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
        <span class="err">@</span><span class="n">group_list</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="err">@</span><span class="n">group_list</span><span class="p">.</span><span class="n">not_nil</span><span class="o">!</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="err">@</span><span class="n">size</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></figure>






<a href="/ac-library.cr/docs/">Back to top page</a>




      </section>
      <footer>
        
        <p><small>Hosted on GitHub Pages  Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/ac-library.cr/docs/assets/js/scale.fix.js"></script>
  </body>
</html>
